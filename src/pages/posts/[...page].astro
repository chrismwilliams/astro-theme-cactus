---
import type { CollectionEntry } from "astro:content";
import type { GetStaticPaths } from "astro";
import { Icon } from "astro-icon/components";
import PostPreview from "@/components/blog/PostPreview.astro";
import { getAllPosts, getUniqueTags, groupPostsByYear } from "@/data/post";
import { t } from "@/i18n";
import PageLayout from "@/layouts/Base.astro";
import { collectionDateSort } from "@/utils/date";

export const getStaticPaths = (async () => {
  const MAX_TAGS = 7;
  const allPosts = await getAllPosts();
  const allPostsByDate = allPosts.sort(collectionDateSort);
  const uniqueTags = getUniqueTags(allPosts).slice(0, MAX_TAGS);
  const pinnedPosts = allPostsByDate.filter((p) => p.data.pinned);
  return [
    {
      params: { page: undefined },
      props: { uniqueTags, pinnedPosts, allPostsByDate },
    },
  ];
}) satisfies GetStaticPaths;

interface Props {
  uniqueTags: string[];
  pinnedPosts: CollectionEntry<"post">[];
  allPostsByDate: CollectionEntry<"post">[];
}

const { uniqueTags, pinnedPosts, allPostsByDate } = Astro.props;

const meta = {
  description: t.posts.description,
  title: t.posts.title,
};

const groupedByYear = groupPostsByYear(allPostsByDate);
const descYearKeys = Object.keys(groupedByYear).sort((a, b) => +b - +a);
---

<PageLayout meta={meta}>
  <div class="mb-12 flex items-center gap-3">
    <h1 class="title" data-i18n="posts.title">{t.posts.title}</h1>
    <a class="text-accent" href="/rss.xml" target="_blank">
      <span class="sr-only" data-i18n="global.rssFeed">{t.global.rssFeed}</span>
      <Icon
        aria-hidden="true"
        class="h-6 w-6"
        focusable="false"
        name="mdi:rss"
      />
    </a>
  </div>
  <div class="grid sm:grid-cols-[3fr_1fr] sm:gap-x-8 sm:gap-y-16">
    <div>
      {
        pinnedPosts.length > 0 && (
          <section class="mb-16" id="pinned-section">
            <h2 class="title mb-6 text-xl" data-i18n="posts.pinnedPosts">
              {t.posts.pinnedPosts}
            </h2>
            <ul class="space-y-4" role="list" id="pinned-list">
              {pinnedPosts.map((p) => (
                <li
                  class="grid gap-1 sm:grid-cols-[auto_1fr] lang-item"
                  data-lang={p.data.lang}
                >
                  <PostPreview post={p} />
                </li>
              ))}
            </ul>
          </section>
        )
      }
      {
        descYearKeys.map((yearKey) => (
          <section class="mb-16 year-section" data-year={yearKey}>
            <h2 id={`year-${yearKey}`} class="title text-lg">
              <span class="sr-only">{t.posts.postsIn}</span>
              {yearKey}
            </h2>
            <ul class="mt-5 space-y-4 text-start">
              {groupedByYear[yearKey]?.map((p) => (
                <li
                  class="grid gap-1 sm:grid-cols-[auto_1fr] sm:[&_q]:col-start-2 lang-item"
                  data-lang={p.data.lang}
                >
                  <PostPreview post={p} />
                </li>
              ))}
            </ul>
          </section>
        ))
      }
    </div>
    {
      !!uniqueTags.length && (
        <aside>
          <h2
            class="title mb-4 flex items-center gap-2 text-lg"
            data-i18n="tags.title"
          >
            {t.tags.title}
            <svg
              aria-hidden="true"
              class="h-6 w-6"
              fill="none"
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1.5"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path d="M0 0h24v24H0z" fill="none" stroke="none" />
              <path d="M7.859 6h-2.834a2.025 2.025 0 0 0 -2.025 2.025v2.834c0 .537 .213 1.052 .593 1.432l6.116 6.116a2.025 2.025 0 0 0 2.864 0l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-6.117 -6.116a2.025 2.025 0 0 0 -1.431 -.593z" />
              <path d="M17.573 18.407l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-7.117 -7.116" />
              <path d="M6 9h-.01" />
            </svg>
          </h2>
          <ul class="flex flex-wrap gap-2">
            {uniqueTags.map((tag) => (
              <li>
                <a
                  class="cactus-link flex items-center justify-center"
                  href={`/tags/${tag}/`}
                >
                  <span aria-hidden="true">#</span>
                  <span class="sr-only">{t.tags.viewPostsWithTag}</span>
                  {tag}
                </a>
              </li>
            ))}
          </ul>
          <span class="mt-4 block sm:text-end">
            <a class="hover:text-link" href="/tags/">
              {t.tags.viewAll} <span aria-hidden="true">â†’</span>
              <span class="sr-only">{t.tags.blogTags}</span>
            </a>
          </span>
        </aside>
      )
    }
  </div>
</PageLayout>

<script>
  const MAX_PINNED = 3;

  function filterByLanguage() {
    const lang = localStorage.getItem("lang") || "en";
    const items = document.querySelectorAll(".lang-item");
    let pinnedShown = 0;

    items.forEach((item) => {
      const itemLang = item.getAttribute("data-lang");
      const parent = item.closest("ul");
      const parentId = parent?.id;

      if (itemLang !== lang) {
        (item as HTMLElement).style.display = "none";
        return;
      }

      // Limit pinned posts
      if (parentId === "pinned-list" && pinnedShown >= MAX_PINNED) {
        (item as HTMLElement).style.display = "none";
        return;
      }

      (item as HTMLElement).style.display = "";
      if (parentId === "pinned-list") pinnedShown++;
    });

    // Hide pinned section if no pinned posts visible
    const pinnedSection = document.getElementById("pinned-section");
    if (pinnedSection && pinnedShown === 0) {
      pinnedSection.style.display = "none";
    } else if (pinnedSection) {
      pinnedSection.style.display = "";
    }

    // Hide year sections with no visible posts
    document.querySelectorAll(".year-section").forEach((section) => {
      const hasPosts = Array.from(section.querySelectorAll(".lang-item")).some(
        (item) => (item as HTMLElement).style.display !== "none"
      );
      (section as HTMLElement).style.display = hasPosts ? "" : "none";
    });
  }

  document.addEventListener("DOMContentLoaded", filterByLanguage);
</script>
